\documentclass[11pt]{article}

\usepackage[margin=1in]{geometry}
\usepackage{amsmath,amssymb,amsfonts}
\usepackage{xcolor}
\usepackage{amsthm}
\usepackage{mathtools}
\usepackage[]{hyperref}
\hypersetup{
  colorlinks=false,
}
\usepackage{cleveref}
\usepackage{todonotes}

\newtheorem{property}{Property}
\newtheorem{definition}{Definition}
\newtheorem{claim}{Claim}
\newtheorem{rrule}{Rule}
\newtheorem{thm}{Theorem}

% \title{Consensus with Permissionless Quorums in the Stellar Network}
% A reference to Cachin's paper:
\title{Asymmetric Distributed Trust in a Permissionless System}
\date{\today}
\author{Giuliano Losa}

\begin{document}

\maketitle

\abstract{
  Fail-prone systems capture assumptions about which processes may fail together during an execution of a distributed system, and to every fail-prone system corresponds a canonical quorum system that can be used to solve tasks such as read-write registers and consensus. A disadvantage of quorum systems is that require prior system-wide agreement on the notion of quorum, which is hard to achieve in a permissionless system. Even asymmetric quorums systems, where each process makes its own assumptions, require that every two processes make compatible assumptions, which again is hard to achieve in a permissionless system. The Stellar Network offers a practical scheme to obtain a federated byzantine quorum system (FBQS for short), which can be used to solve consensus, in a permissionless network. However, the relationship between the FBQS model and traditional quorum systems is not well-understood. In this paper we show that, similarly to traditional quorum systems, a FBQS corresponds to assumptions about failures that are formalized using a fail-prone system.
}

\section{Introduction}

% Following Cachin and Tackmann, we define an asymmetric fail-prone system $\mathbb{F}=\left[\mathcal{F}_1,...,\mathcal{F}_n\right]$ as a family of fail-prone systems, where the fail-prone system $\mathcal{F}_i$ is a set of sets of processes that denote the trust assumptions of process $p_i$. However, we interpret the assumption encoded by a fail-prone system differently from Cachin and Tackmann.

A common problem in a distributed system is to solve a task (e.g.\ consensus) given some assumption about the possible failures that may occur. For example, one may describe possible failures using fail-prone systems. A fail-prone system $\mathcal{F}=\left\{F_1,...,F_n\right\}$ is a set of sets of processes called fail-prone sets. $\mathcal{F}$ denotes the assumption that, in a given execution, the set of processes that actually fail and collude to disrupt the system is exactly one of the $F_i$s. However, the processes do not know which one it is.

A quorum system for $\mathcal{F}$ is a set of quorums, which are sets of processes, such that (a) the intersection of two quorums is not a subset of a fail-prone set and (b) for every fail-prone set $F$, there is a quorum disjoint from $F$. This guarantees that, in a given execution where the real set of processes that fail is $F\in\mathcal{F}$, every two quorums have a non-faulty member in common, and there is at least one quorum that is exclusively non-faulty. Given a quorum system, there are well-known algorithms for implementing various task, such as read-write registers or, under eventual synchrony, consensus.

Hirt and Maurer show that there exists a quorum system for $\mathcal{F}$ if and only if no three fail-prone sets cover the whole system (this property is called property $Q^3(\mathcal{F})$). Moreover, every fail-prone system that satisfying $Q^3(\mathcal{F})$ determines a canonical quorum system $\overline{\mathcal{F}}$ where $Q$ is a quorum if and only if $Q$ is the complement of a fail-prone set. Thus, fail-prone systems neatly capture the space of failures can be tolerated with a quorum system, and for each such failure specification there is a natural quorum system to use.%$Q\in\overline{\mathcal{F}}$ if and only if there exists a fail-prone set $F\in\mathcal{F}$ such that $Q=\mathcal{P}\setminus F$.

Cachin and Tackmann generalize fail-prone systems to asymmetric fail-prone systems, where each process makes its own assumptions about which processes may fail together. An asymmetric fail-prone system is a family of fail-prone systems $\mathbb{F}=\left\{\mathcal{F}_1,...,\mathcal{F}_n\right\}$ where $\mathcal{F}_i$ is a fail-prone system denoting the assumptions of process $p_i$.

Similarly, an asymmetric quorum system is a family of quorum systems $\mathbb{Q}=\left\{\mathcal{Q}_1,...,\mathcal{Q}_n\right\}$ where $\mathcal{Q}_i$ is the quorum system of process $p_i$. $\mathbb{Q}$ must be such that (a) for every two processes $p_i$ and $p_j$ and for every two quorums $Q_i$ of $p_i$ and $Q_j$ of $p_j$, $Q_i\cap Q_j$ contains a process which both $p_i$ and $p_j$ assume is not faulty, and (b) for every set of process $F_i$ that $p_i$ assume may fail together, there is a quorum of $p_i$ that is disjoint from $F_i$. Those conditions enable solving useful distributed computing tasks such as read-write registers and broadcast using well-known techniques. Moreover, Cachin and Tackmann show that property $Q^3(\mathcal{F})$ generalizes as follows TODO
%and that an asymmetric quorum system $\mathcal{F}$ that satisfies $Q^3(\mathcal{F})$ determines a canonical asymmetric quorum system... TODO

We could say that asymmetric quorum systems improve decentralization because there is no need to agree a-priori on the notion of quorum. However, satisfying property $Q^3(\mathcal{F})$ still requires prior coordination. Hence the question: how can a set of processes that initially have no notion of quorum system synchronize to obtain an asymmetric quorum system? Moreover, how can they do so in a decentralized manner, without using a central authority?

The Stellar Network offers a practical solution to this problem. However, as Cachin and Tackmann observe, the asymmetric quorum-system model does not capture Stellar's Federated Byzantine Quorum System model (the FBQS model for short). In this paper, we show that, similarly to symmetric and asymmetric quorum systems, a FBQS can be understood in terms of a fail-prone system.

%indeed, how are two processes that never talked to each other supposed to make failure assumptions that satisfy $Q^3(\mathcal{F})$?

% In a FBQS, processes do not know who the system participants are exactly. Instead, each process $p_i$ only knows of a subset $P_i$ of the participants and makes assumptions about failures using a fail-prone system $\mathcal{F}_i$ over $P_i$. Moreover, the meaning of the fail-prone system is different from previous work: process $p_i$ assumes that, in every execution, (a) it has made accurate assumptions, i.e.\ the set of process that actually fail is a set $F$ such that $P_i\cap F \in\mathcal{F}_i$, (b) the processes in $P_i\setminus F$ in turn have made accurate assumptions, and (c) so on recursively.

\section{Federated Quorum Systems}

In a FBQS, processes do not know who the system participants are exactly.
Instead, each process $p_i$ knows a subset $P_i$ of the participants (where $p_i\not\in P_i$) that $p_i$ trusts to present accurate information about the rest of the system.
However, $p_i$ trusts members of $P_i$ to the extent that they may fail, and $p_i$ makes assumptions about those failures using a fail-prone system $\mathcal{F}_i$ over $P_i$ (i.e.\ $\mathcal{F}_i\in 2^{P_i}$).
Note that two processes $p_i$ and $p_j$ may have disjoint trusted sets, i.e.\ it is well possible that $P_i\cap P_j=\emptyset$.
Thus a federated fail-prone system is an array $\mathbb{F}=\left\{\left(P_1,\mathcal{F}_1\right),...,\left(P_n,\mathcal{F}_n\right)\right\}$ that associates to each $p_i$ a set of trusted peers $P_i$ and a fail-prone system $\mathcal{F}_i$ over $P_i$.%Moreover, $\mathbb{F}$ must satisfy property $Q^3(\mathbb{F})$ defined below.
We now consider a fixed such $\mathbb{F}$.

The assumptions of the processes, embodied in $\mathbb{F}$, are satisfied in an execution if and only if the set of processes that actually fail is a set $A$ such that, for every $p_i$, there exists $F\in\mathcal{F}_i$ such that $P_i\cap A \subseteq F$; we say that such a set $A$ is fail-compatible with $\mathbb{F}$.

Given a process $p_i$ and $F\in \mathcal{F}_i$, we say that $\{p_i\}\cup P_i\setminus F$ is a slice of $p_i$.
Define a slice choice $\mathcal{S}$ as an array $\left[S_1,...,S_n\right]$ of slices, where, for every $i$, $S_i$ is a slice of $p_i$.
Define a slice-choice graph $G$ as a directed graph whose nodes are processes and such that there exists a slice choice $\left[S_1,...,S_n\right]$ such that, for every $p_i$ and $p_j$, there is an edge from $p_i$ to $p_j$ whenever $p_j\in S_i$. Note that slice-choice arrays determines a slice-choice graph and vice versa.
Given a slice choice $\mathcal{S}=\left[S_1,...,S_n\right]$ and a set of processes $P$, we say that $P$ is closed under $\mathcal{S}$ if, for every $p_i$ in $P$, $S_i$ is a subset of $P$.

% To sum up, a federated fail-prone system as a family of fail-prone systems $\mathbb{F}=\left\{\left(P_1,\mathcal{F}_1\right),...,\left(P_n,\mathcal{F}_n\right)\right\}$ where $P_i$ is the set of processes that $p_i$ knows of and $\mathcal{F}_i$ is a fail-prone system over $P_i$ that denotes the assumptions that $p_i$ makes about the possible failures of members of $P_i$.

% Note that two processes $p_i$ and $p_j$ may not even know of a common third process, i.e.\ it is well possible that $P_i\cap P_j=\emptyset$.
% As should become apparent in definition of Property $Q^3(\mathbb{F})$ below, to stay in agreement despite this apparent problem, processes in a FBQS rely on a transitive reachability property that must hold despite failures.

% We now make two definitions that we use to define Property $Q^3(\mathbb{F})$ below. Define the directed graph $G_\mathbb{F}$ over processes such that there is an edge from $p_i$ to $p_j$ if and only if $p_j\in P_i$. Given a set of processes $S$, a fail-prone set over $S$ is a set of processes obtained by taking the union over all processes in $S$ of one fail-prone set per process. Formally, $T$ is a fail-prone set over $S$ if and only if there exists a family of fail-prone sets $\left\{F_1,...,F_n\right\}$ such that (a), for every $p_i\in S$, $F_i\in \mathcal{F}_i$ and (b) $T=\bigcup_{p_i\in S} F_i$.

% Let $G_\mathbb{F}^*$ be the transitive closure of $G_\mathbb{F}$, i.e. $G_\mathbb{F}^*(p_i)$ is the set of processes reachable from $p_i$ in $G_\mathbb{F}$.

% To define a federated quorum systems for a fail-prone system $\mathbb{F}=\left\{\left(P_1,\mathcal{F}_1\right),...,\left(P_n,\mathcal{F}_n\right)\right\}$, we first need the notion of fail-prone set over a subset $S$ of the processes. Given a set of processes $S$, a fail-prone set over $S$ is a set of processes obtained by taking the union over all processes in $S$ of one fail-prone set per process. Formally, $T$ is a fail-prone set over $S$ if and only if there exists a family of fail-prone sets $\left\{F_1,...,F_n\right\}$ such that (a), for every $p_i\in S$, $F_i\in \mathcal{F}_i$ and (b) $T=\bigcup_{p_i\in S} F_i$.

Given the above preliminary definitions, we know define property $Q^3(\mathbb{F})$ for federated fail-prone systems. This generalizes property $Q^3$ of fail-prone systems and asymmetric fail-prone systems.\todo{Is this a generalization in the sense that symmetric fail-prone systems are a special case? It seems to be a true generalization.}

\begin{definition}[Property $Q^3(\mathbb{F})$]
  Property $Q^3(\mathbb{F})$ holds if and only if for every two processes $p_i$ and $p_j$, for every slice-choice graph $G$, for every fail-compatible set $A$, there exist two paths $x_i$ and $x_j$ in $G$ such that:
  \begin{itemize}
    \item $x_i$ starts at $p_i$ and $x_j$ starts at $p_j$,
    \item $x_i$ and $x_j$ intersect, and
    \item both $x_i$ and $x_j$ are disjoint from $A$.
  \end{itemize}
\end{definition}

Informally, Property $Q^3(\mathbb{F})$ captures the essence of the assumptions made by processes in a federated fail-prone system, i.e.\ that for every possible slice-choice graph, two processes can reach a common third process despite any failures compatible with the processes' failure assumptions.

Also note that, having defined Property $Q^3(\mathbb{F})$ as above, fail-prone systems and asymmetric fail-prone systems are a special case of federated fail-prone systems.\todo{Provide an explanation.}

We are now ready to define federated quorum systems for $\mathbb{F}$ and show that there exists a federated quorum system for $\mathbb{F}$ if and only if $Q^3(\mathbb{F})$ holds. A federated quorum system for $\mathbb{F}$ is a family of quorum systems $\mathbb{Q}=\left\{Q_1,...,Q_n\right\}$, where $Q_i\subseteq 2^\mathcal{P}$ is a quorum system for $p_i$. Moreover, $\mathbb{Q}$ must satisfy the following three properties.
\begin{itemize}
  \item [Closure] If $Q_i$ is a quorum of $p_i$ and $p_j\in Q_i$, then there exists a quorum $Q_j$ of $p_j$ such that $Q_j\subseteq Q_i$.\todo{needed?}
  % \item [Availability] If $F$ is a fail-prone set of $p_i$, then there exists a quorum $Q$ of $p_i$ such that $P_i\setminus F \subseteq Q$.
  \item [Availability] For every fail-compatible set $A$ and for every process $p_i$, there exists a quorum $Q$ of $p_i$ that is disjoint from $A$.
  \item[Consistency] If $Q_i$ is a quorum of $p_i$ and $Q_j$ is a quorum of $p_j$, if $\mathcal{S}$ is a slice choice such that $Q_i\cup Q_j$ is closed under $\mathcal{S}$, and if $A$ is a fail-compatible set, then there are two paths $x_i$ and $x_j$ in the slice-choice graph $G$ corresponding to $\mathcal{S}$ such that
    \begin{itemize}
      \item $x_i$ starts at $p_i$ and $x_j$ starts at $p_j$,
      \item $x_i$ and $x_j$ consists exclusively of processes in $\left(Q_i\cup Q_j\right)\setminus A$,
      \item $x_i$ and $x_j$ intersect.
    \end{itemize}
\end{itemize}

Informally, the Consistency property states that not only must the quorums of two processes $p_i$ and $p_j$ intersect despite failures, but some process in the intersection must be reachable from $p_i$ and $p_j$ despite failures.

\begin{thm}
  There exists a federated quorum system for $\mathbb{F}$ if and only if $Q^3(\mathbb{F})$ holds.
\end{thm}

To prove the theorem, we first show that for every federated fail-prone system $\mathcal{F}$ satisfying $Q^3(\mathcal{F})$, there exists a canonical quorum system $\overline{\mathbb{F}}$ for $\mathbb{F}$. Second, we show that if $\mathbb{Q}$ is a federated quorum system for $\mathcal{F}$, then $Q^3(\mathcal{F})$ must hold.

\begin{definition}[Canonical federated quorum system for $\mathbb{F}$]
  Given a federated fail-prone system $\mathbb{F}$ satisfying $Q^3(\mathbb{F})$, we define $\overline{\mathbb{F}}=\left\{\mathcal{Q}_1,...,\mathcal{Q}_n\right\}$, where the set $\mathcal{Q}_i$ of quorums of $p_i$ is the biggest set such that, for every $Q\in\mathcal{Q}_i$,
  \begin{enumerate}
    \item $p_i\in Q$ and
    \item for every $p_j\in Q$, $p_j$ has a slice that is a subset of $Q$.%(i.e.\ there is a fault-prone set $F$ of $p_j$ such that $P_j\setminus F\subseteq Q$).
  \end{enumerate}
\end{definition}

Note that if we identify the notion of slice with the notion of quorum slice of Mazières, then the definition of quorums above coincides with Mazières' definition; thus a canonical federated quorum systems is isomorphic to a Federated Byzantine Quorum System as defined by Mazières.\todo{what about the projection business?}

\begin{claim}
 $\overline{\mathbb{F}}$, the canonical federated quorum system for $\mathbb{F}$, satisfies the Closure, Availability, and Consistency properties.
\end{claim}
\begin{proof}
  $\overline{\mathbb{F}}$ satisfies the Availability Property by definition of $\overline{\mathbb{F}}$ because, given a fail-compatible set $A$, we can construct a quorum containing all nodes: by definition of fail-compatible, for every $p_i$ there exists a slice of $p_i$ that is disjoint from $A$. Let the array $\left[S_1,...,S_n\right]$ identify one such slice per process. Now the union of all the slices in the array is by definition a quorum for every process and it is disjoint from $A$.

  Moreover, observe that if $Q$ is a quorum of $p_i$ and $p_j\in Q$, then we immediately have, by definition of $\overline{\mathbb{F}}$, that $Q$ is also a quorum of $p_j$; thus $\overline{\mathbb{F}}$ satisfies the Closure Property.

  Finally, consider two processes $p_i$ and $p_j$, two quorums $Q_i$ of $p_i$ and $Q_j$ of $p_j$, a slice-choice $\mathcal{S}$ such that $Q_i\cup Q_j$ is closed under $\mathcal{S}$, and a fail-compatible set $A$. By Property $Q^3(\mathbb{F})$, we immediately obtain two paths $x_i$ and $x_j$ in the slice-choice graph $G$ corresponding to $\mathcal{S}$ such that
    \begin{itemize}
      \item $x_i$ starts at $p_i$ and $x_j$ starts at $p_j$,
      \item $x_i$ and $x_j$ intersect, and
      \item neither $x_i$ and $x_j$ are disjoint from $A$.
    \end{itemize}
    Thus, to show that $\overline{\mathbb{F}}$ satisfies the Consistency property, it remains to show that $x_i$ consists exclusively of processes in $Q_i\cup Q_j$. This is the case because $Q_i\cup Q_j$ is closed under the slice-choice $\mathcal{S}$, and thus no path in $G$ that starts in $Q_i\cup Q_j$ can exit $Q_i\cup Q_j$.
\end{proof}

\begin{claim}
  If $\mathbb{Q}$ is a federated quorum system for $\mathbb{F}$ that satisfies the Availability property and $\mathbb{F}$ does not satisfy $Q^3(\mathbb{F})$, then $\mathbb{Q}$ does not satisfy the Consistency property.
\end{claim}
\begin{proof}
  By the assumption that $\mathbb{F}$ does not satisfy $Q^3(\mathbb{F})$, there are two processes $p_i$ and $p_j$, a slice-choice graph $G$, and a fail-compatible set $A$, such that there are no paths $x_i$ and $x_j$ such that:
  \begin{enumerate}
    \item $x_i$ starts at $p_i$ and $x_j$ starts at $p_j$,
    \item $x_i$ and $x_j$ intersect, and
    \item both $x_i$ and $x_j$ are disjoint from $A$.
  \end{enumerate}
  Moreover, consider the slice choice array $\mathcal{S}=\left[S_1,...,S_n\right]$ corresponding to the slice-choice graph $G$.
  Consider $Q=\bigcup_{i\in 1..n}S_i$. By definition, $Q$ is a quorum of both $p_i$ and $p_j$.
  Now suppose by contradiction that $\mathbb{Q}$ satisfies the Consistency property. Then there are two paths $x_i'$ and $x_j'$ in the slice-choice graph $G$ corresponding to $\mathcal{S}$ such that
  \begin{itemize}
    \item $x_i'$ starts at $p_i$ and $x_j$ starts at $p_j$,
    \item $x_i'$ and $x_j'$ consists exclusively of processes in $Q\setminus A$,
    \item $x_i'$ and $x_j'$ intersect.
  \end{itemize}
  Then $x_i'$ and $x_j'$ satisfy Items 1, 2 and 3 above, which is a contradiction. Thus $\mathbb{Q}$ does not satisfy the Consistency property.
\end{proof}

% \begin{center}
% \begin{tabular}{ |c|c| }
  % \hline
  % node & quorums \\
  % \hline
  % $n_1$ & \{  \\
  % \hline
  % $n_2$ & cell5 \\
  % \hline
  % $n_3$ & cell8 \\
  % \hline
  % $n_4$ & cell8 \\
  % \hline
  % $n_5$ & cell8 \\
  % \hline
% \end{tabular}
% \end{center}

\end{document}
